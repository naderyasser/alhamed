{% extends 'admin/base.html' %}
{% block title %}دروب شوبينج - لوحة التحكم{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="admin-card p-6">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-red-600 to-red-800 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class='bx bx-link-external text-2xl'></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white">دروب شوبينج</h1>
                    <p class="text-gray-500 text-sm">استورد منتجات من أي موقع بلصق الرابط فقط</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scrape URL Form -->
    <div class="admin-card p-6">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <i class='bx bx-search-alt text-red-500'></i>
            جلب منتج من رابط
        </h2>
        <form method="POST" action="{{ url_for('admin.dropshipping_scrape') }}" class="space-y-4">
            <div class="flex flex-col md:flex-row gap-3">
                <div class="flex-1 relative">
                    <input type="url" name="url" required placeholder="الصق رابط المنتج هنا... (مثال: https://www.amazon.eg/product/...)" 
                        class="w-full p-3 pr-10 rounded-lg text-sm" dir="ltr">
                    <i class='bx bx-link absolute right-3 top-1/2 -translate-y-1/2 text-gray-500'></i>
                </div>
                <button type="submit" class="btn-accent px-6 py-3 rounded-lg flex items-center justify-center gap-2 whitespace-nowrap">
                    <i class='bx bx-import'></i>
                    <span>جلب البيانات</span>
                </button>
            </div>
            <p class="text-xs text-gray-600">يدعم معظم المتاجر الإلكترونية - الصق رابط المنتج وسيتم جلب البيانات تلقائياً</p>
        </form>
    </div>

    <!-- Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="admin-card p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">إجمالي المنتجات</p>
                    <p class="text-2xl font-bold text-white mt-1">{{ items|length }}</p>
                </div>
                <div class="w-10 h-10 rounded-xl bg-blue-900/30 flex items-center justify-center">
                    <i class='bx bx-package text-blue-400 text-xl'></i>
                </div>
            </div>
        </div>
        <div class="admin-card p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">تم الاستيراد</p>
                    <p class="text-2xl font-bold text-green-400 mt-1">{{ items|selectattr('status', 'eq', 'imported')|list|length }}</p>
                </div>
                <div class="w-10 h-10 rounded-xl bg-green-900/30 flex items-center justify-center">
                    <i class='bx bx-check-circle text-green-400 text-xl'></i>
                </div>
            </div>
        </div>
        <div class="admin-card p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">في الانتظار</p>
                    <p class="text-2xl font-bold text-yellow-400 mt-1">{{ items|selectattr('status', 'eq', 'pending')|list|length }}</p>
                </div>
                <div class="w-10 h-10 rounded-xl bg-yellow-900/30 flex items-center justify-center">
                    <i class='bx bx-time-five text-yellow-400 text-xl'></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Products List -->
    {% if items %}
    <div class="space-y-4">
        {% for item in items %}
        <div class="admin-card overflow-hidden">
            <div class="flex flex-col lg:flex-row">
                <!-- Product Image -->
                <div class="lg:w-48 h-48 lg:h-auto flex-shrink-0 bg-dark-50 flex items-center justify-center overflow-hidden">
                    {% if item.image_url %}
                    <img src="{{ item.image_url }}" alt="{{ item.name }}" class="w-full h-full object-cover" 
                         onerror="this.src='{{ url_for('static', filename='images/placeholder.png') }}'">
                    {% else %}
                    <div class="text-center text-gray-600 p-4">
                        <i class='bx bx-image text-4xl'></i>
                        <p class="text-xs mt-2">لا توجد صورة</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Product Info -->
                <div class="flex-1 p-5">
                    <div class="flex flex-col md:flex-row justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h3 class="text-lg font-bold text-white">{{ item.name or 'بدون اسم' }}</h3>
                                {% if item.status == 'imported' %}
                                <span class="px-2 py-1 text-xs rounded-full bg-green-900/40 text-green-400">تم الاستيراد</span>
                                {% elif item.status == 'error' %}
                                <span class="px-2 py-1 text-xs rounded-full bg-red-900/40 text-red-400">خطأ</span>
                                {% else %}
                                <span class="px-2 py-1 text-xs rounded-full bg-yellow-900/40 text-yellow-400">في الانتظار</span>
                                {% endif %}
                            </div>
                            
                            {% if item.price %}
                            <p class="text-red-400 font-bold text-xl mb-2">{{ item.price }} ج.م</p>
                            {% endif %}
                            
                            {% if item.description %}
                            <p class="text-gray-500 text-sm line-clamp-2 mb-3">{{ item.description[:150] }}{% if item.description|length > 150 %}...{% endif %}</p>
                            {% endif %}
                            
                            <div class="flex items-center gap-3 text-xs text-gray-600">
                                <span class="flex items-center gap-1">
                                    <i class='bx bx-globe'></i>
                                    {{ item.source_site or 'غير معروف' }}
                                </span>
                                <span class="flex items-center gap-1">
                                    <i class='bx bx-time'></i>
                                    {{ item.created_at.strftime('%Y/%m/%d') }}
                                </span>
                            </div>
                            
                            {% if item.error_message %}
                            <p class="text-red-400 text-sm mt-2 flex items-center gap-1">
                                <i class='bx bx-error'></i>
                                {{ item.error_message }}
                            </p>
                            {% endif %}
                        </div>

                        <!-- Actions -->
                        <div class="flex flex-col gap-2 min-w-[160px]">
                            {% if item.status == 'pending' %}
                            <button onclick="openImportModal({{ item.id }}, '{{ item.name|e }}', {{ item.price or 0 }}, '{{ item.description|e if item.description else '' }}')" 
                                class="btn-accent px-4 py-2 rounded-lg flex items-center justify-center gap-2 text-sm">
                                <i class='bx bx-download'></i>
                                استيراد كمنتج
                            </button>
                            {% elif item.status == 'imported' and item.imported_product_id %}
                            <a href="{{ url_for('shop.product', product_id=item.imported_product_id) }}" target="_blank"
                                class="px-4 py-2 rounded-lg flex items-center justify-center gap-2 text-sm bg-green-900/30 text-green-400 border border-green-800 hover:bg-green-900/50">
                                <i class='bx bx-show'></i>
                                عرض المنتج
                            </a>
                            {% endif %}
                            
                            <a href="{{ item.source_url }}" target="_blank" 
                                class="px-4 py-2 rounded-lg flex items-center justify-center gap-2 text-sm bg-dark-50 text-gray-400 border border-gray-800 hover:border-gray-600">
                                <i class='bx bx-link-external'></i>
                                المنتج الأصلي
                            </a>
                            
                            <form method="POST" action="{{ url_for('admin.dropshipping_delete', item_id=item.id) }}" 
                                onsubmit="return confirm('هل أنت متأكد من حذف هذا المنتج؟')">
                                <button type="submit" class="w-full px-4 py-2 rounded-lg flex items-center justify-center gap-2 text-sm text-red-400 border border-red-900/50 hover:bg-red-900/20">
                                    <i class='bx bx-trash'></i>
                                    حذف
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="admin-card p-12 text-center">
        <i class='bx bx-link-external text-5xl text-gray-700 mb-4'></i>
        <h3 class="text-xl font-bold text-gray-400 mb-2">لا توجد منتجات مستوردة بعد</h3>
        <p class="text-gray-600 mb-6">الصق رابط أي منتج من أي متجر إلكتروني وسيظهر هنا كأنه منتجك</p>
    </div>
    {% endif %}
</div>

<!-- Import Modal -->
<div id="importModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4">
    <div class="admin-card w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <h2 class="text-xl font-bold text-white">استيراد المنتج</h2>
            <button onclick="closeImportModal()" class="text-2xl text-gray-500 hover:text-white">&times;</button>
        </div>

        <form id="importForm" method="POST" class="p-6 space-y-4">
            <div>
                <label class="block mb-2 font-medium text-gray-300">اسم المنتج <span class="text-red-500">*</span></label>
                <input type="text" name="name" id="importName" required class="w-full p-3 rounded-lg">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block mb-2 font-medium text-gray-300">السعر (ج.م) <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" name="price" id="importPrice" required class="w-full p-3 rounded-lg">
                </div>
                <div>
                    <label class="block mb-2 font-medium text-gray-300">الخصم (%)</label>
                    <input type="number" name="discount" value="0" min="0" max="100" class="w-full p-3 rounded-lg">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block mb-2 font-medium text-gray-300">الكمية</label>
                    <input type="number" name="stock" value="10" min="0" class="w-full p-3 rounded-lg">
                </div>
                <div>
                    <label class="block mb-2 font-medium text-gray-300">التصنيف <span class="text-red-500">*</span></label>
                    <select name="category_id" required class="w-full p-3 rounded-lg">
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div>
                <label class="block mb-2 font-medium text-gray-300">الوصف</label>
                <textarea name="description" id="importDescription" rows="3" class="w-full p-3 rounded-lg"></textarea>
            </div>

            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeImportModal()" class="px-6 py-2 bg-dark-50 text-gray-400 rounded-lg hover:bg-dark-100 border border-gray-700">
                    إلغاء
                </button>
                <button type="submit" class="px-6 py-2 btn-accent rounded-lg flex items-center">
                    <i class='bx bx-download mr-2'></i>
                    استيراد المنتج
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function openImportModal(itemId, name, price, description) {
    const modal = document.getElementById('importModal');
    const form = document.getElementById('importForm');
    form.action = `/admin/dropshipping/import/${itemId}`;
    document.getElementById('importName').value = name;
    document.getElementById('importPrice').value = price;
    document.getElementById('importDescription').value = description;
    modal.classList.remove('hidden');
}

function closeImportModal() {
    document.getElementById('importModal').classList.add('hidden');
}

document.getElementById('importModal').addEventListener('click', function(e) {
    if (e.target === this) closeImportModal();
});
</script>
{% endblock %}
