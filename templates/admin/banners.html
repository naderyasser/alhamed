{% extends 'admin/base.html' %} {% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 to-black">

    <!-- Header -->
    <div class="bg-black/80 backdrop-blur-sm border-b border-gray-800 sticky top-0 z-10 shadow-sm">
        <div class="px-6 py-4">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-red-600 to-red-800 rounded-xl flex items-center justify-center text-white shadow-lg">
                        <i class='bx bx-image-alt text-2xl'></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">إدارة البانرات</h1>
                        <p class="text-gray-400 text-sm">تحكم في صور وشرائح الصفحة الرئيسية</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button onclick="document.getElementById('addModal').classList.remove('hidden')"
                        class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-6 py-3 rounded-xl flex items-center gap-2 transition-all duration-300 shadow-lg">
                        <i class='bx bx-plus text-lg'></i>
                        <span class="font-medium">إضافة بانر جديد</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="px-6 pt-6">
        <div class="space-y-3">
            {% for cat, message in messages %}
            <div class="p-4 rounded-xl flex items-center gap-3 border-l-4
                {% if cat == 'success' %}bg-green-900/30 border-green-500 text-green-300
                {% elif cat == 'error' %}bg-red-900/30 border-red-500 text-red-300
                {% else %}bg-blue-900/30 border-blue-500 text-blue-300{% endif %}">
                <i class="bx {{ 'bx-check-circle' if cat == 'success' else 'bx-info-circle' }} text-xl"></i>
                <span class="font-medium">{{ message }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endwith %}

    <!-- Stats -->
    <div class="px-6 py-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white"><i class='bx bx-image text-xl'></i></div>
                    <span class="text-3xl font-bold text-white">{{ banners|length }}</span>
                </div>
                <h3 class="text-gray-400 font-medium">إجمالي البانرات</h3>
            </div>
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-10 h-10 bg-green-600 rounded-xl flex items-center justify-center text-white"><i class='bx bx-show text-xl'></i></div>
                    <span class="text-3xl font-bold text-white">{{ banners|selectattr('is_active')|list|length }}</span>
                </div>
                <h3 class="text-gray-400 font-medium">بانرات مفعّلة</h3>
            </div>
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-10 h-10 bg-yellow-600 rounded-xl flex items-center justify-center text-white"><i class='bx bx-hide text-xl'></i></div>
                    <span class="text-3xl font-bold text-white">{{ banners|rejectattr('is_active')|list|length }}</span>
                </div>
                <h3 class="text-gray-400 font-medium">بانرات مخفية</h3>
            </div>
        </div>

        <!-- Banners Grid -->
        {% if banners %}
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            {% for b in banners %}
            <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300">
                <!-- Image Preview -->
                <div class="relative h-44 bg-gray-800 overflow-hidden">
                    {% if b.image_url %}
                      {% if b.image_url.startswith('static/') %}
                        <img src="{{ url_for('static', filename=b.image_url[7:]) }}" class="w-full h-full object-cover" alt="{{ b.title }}">
                      {% else %}
                        <img src="{{ b.image_url }}" class="w-full h-full object-cover" alt="{{ b.title }}">
                      {% endif %}
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center text-gray-600">
                        <i class='bx bx-image-alt text-5xl'></i>
                    </div>
                    {% endif %}
                    <!-- Status badge -->
                    <div class="absolute top-2 right-2">
                        {% if b.is_active %}
                        <span class="bg-green-500 text-white text-xs px-3 py-1 rounded-full font-medium">● مفعّل</span>
                        {% else %}
                        <span class="bg-gray-500 text-white text-xs px-3 py-1 rounded-full font-medium">○ مخفي</span>
                        {% endif %}
                    </div>
                    <!-- Order badge -->
                    <div class="absolute top-2 left-2">
                        <span class="bg-black/60 text-white text-xs px-2 py-1 rounded-full">#{{ b.sort_order }}</span>
                    </div>
                </div>

                <!-- Content -->
                <div class="p-4">
                    <h3 class="text-white font-bold text-base mb-1 truncate">{{ b.title or '(بدون عنوان)' }}</h3>
                    {% if b.subtitle %}<p class="text-gray-400 text-sm mb-2 truncate">{{ b.subtitle }}</p>{% endif %}
                    {% if b.highlight_sale_price or b.highlight_regular_price %}
                    <div class="flex items-center gap-2 mb-2">
                        {% if b.highlight_regular_price %}<span class="text-gray-500 line-through text-sm">{{ b.highlight_regular_price }} ج.م</span>{% endif %}
                        {% if b.highlight_sale_price %}<span class="text-red-400 font-bold">{{ b.highlight_sale_price }} ج.م</span>{% endif %}
                        {% if b.highlight_discount %}<span class="bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">-{{ b.highlight_discount }}</span>{% endif %}
                    </div>
                    {% endif %}
                    <p class="text-gray-500 text-xs mb-3 truncate">رابط: {{ b.link_url }}</p>

                    <!-- Actions -->
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="openEditModal({{ b.id }}, {{ b.to_dict()|tojson }})"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition flex items-center justify-center gap-1">
                            <i class='bx bx-edit text-base'></i> تعديل
                        </button>
                        <!-- Toggle active -->
                        <form method="POST" action="{{ url_for('admin.banner_toggle', banner_id=b.id) }}" class="flex-1">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit"
                                class="w-full {{ 'bg-yellow-600 hover:bg-yellow-700' if b.is_active else 'bg-green-600 hover:bg-green-700' }} text-white text-sm py-2 px-3 rounded-lg transition flex items-center justify-center gap-1">
                                <i class='bx {{ "bx-hide" if b.is_active else "bx-show" }} text-base'></i>
                                {{ 'إخفاء' if b.is_active else 'إظهار' }}
                            </button>
                        </form>
                        <!-- Delete -->
                        <form method="POST" action="{{ url_for('admin.banner_delete', banner_id=b.id) }}"
                            onsubmit="return confirm('هل أنت متأكد من حذف هذا البانر؟')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit"
                                class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition flex items-center justify-center gap-1">
                                <i class='bx bx-trash text-base'></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-gray-900 rounded-2xl border border-dashed border-gray-700 p-16 text-center">
            <i class='bx bx-image-alt text-6xl text-gray-600 mb-4 block'></i>
            <h3 class="text-gray-400 text-xl font-semibold mb-2">لا توجد بانرات بعد</h3>
            <p class="text-gray-600 mb-6">أضف أول بانر للصفحة الرئيسية</p>
            <button onclick="document.getElementById('addModal').classList.remove('hidden')"
                class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-xl font-medium transition">
                <i class='bx bx-plus me-2'></i> إضافة بانر
            </button>
        </div>
        {% endif %}
    </div>
</div>


<!-- ─── Add Banner Modal ─── -->
<div id="addModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl">
        <div class="flex items-center justify-between p-6 border-b border-gray-700">
            <h2 class="text-white text-xl font-bold flex items-center gap-2"><i class='bx bx-plus-circle text-red-500'></i> إضافة بانر جديد</h2>
            <button onclick="document.getElementById('addModal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl"><i class='bx bx-x'></i></button>
        </div>
        <form method="POST" action="{{ url_for('admin.banner_add') }}" enctype="multipart/form-data" class="p-6 space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <div>
                <label class="block text-gray-300 text-sm font-medium mb-1">الصورة — رابط URL</label>
                <input type="text" name="image_url" placeholder="https://... أو اترك فارغاً لرفع ملف"
                    class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-red-500 focus:ring focus:ring-red-500/20 outline-none">
            </div>
            <div>
                <label class="block text-gray-300 text-sm font-medium mb-1">أو ارفع صورة</label>
                <input type="file" name="image_file" accept="image/*"
                    class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none file:bg-red-600 file:text-white file:border-0 file:rounded-lg file:px-4 file:py-1 file:me-3 cursor-pointer">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">العنوان الرئيسي</label>
                    <input type="text" name="title" placeholder="عنوان البانر"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-red-500 focus:ring focus:ring-red-500/20 outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">العنوان الفرعي</label>
                    <input type="text" name="subtitle" placeholder="نص فرعي"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-red-500 focus:ring focus:ring-red-500/20 outline-none">
                </div>
            </div>
            <div>
                <label class="block text-gray-300 text-sm font-medium mb-1">الوصف</label>
                <textarea name="description" rows="2" placeholder="نص وصف البانر..."
                    class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-red-500 focus:ring focus:ring-red-500/20 outline-none"></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">السعر الأصلي</label>
                    <input type="text" name="highlight_regular_price" placeholder="مثال: 438"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">سعر البيع</label>
                    <input type="text" name="highlight_sale_price" placeholder="مثال: 350"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">نسبة الخصم</label>
                    <input type="text" name="highlight_discount" placeholder="مثال: 20%"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">رابط زر "تسوقي الآن"</label>
                    <input type="text" name="link_url" value="/shop" placeholder="/shop أو /product/5"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">الترتيب (رقم أصغر = يظهر أولاً)</label>
                    <input type="number" name="sort_order" value="0" min="0"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none">
                </div>
            </div>
            <div class="flex items-center gap-3">
                <input type="checkbox" name="is_active" id="add_is_active" checked class="w-5 h-5 accent-red-600 cursor-pointer">
                <label for="add_is_active" class="text-gray-300 font-medium cursor-pointer">تفعيل البانر فوراً</label>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold transition">
                    <i class='bx bx-save me-2'></i> حفظ البانر
                </button>
                <button type="button" onclick="document.getElementById('addModal').classList.add('hidden')"
                    class="bg-gray-700 hover:bg-gray-600 text-white py-3 px-6 rounded-xl transition">إلغاء</button>
            </div>
        </form>
    </div>
</div>


<!-- ─── Edit Banner Modal ─── -->
<div id="editModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl">
        <div class="flex items-center justify-between p-6 border-b border-gray-700">
            <h2 class="text-white text-xl font-bold flex items-center gap-2"><i class='bx bx-edit text-blue-500'></i> تعديل البانر</h2>
            <button onclick="document.getElementById('editModal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl"><i class='bx bx-x'></i></button>
        </div>
        <form id="editForm" method="POST" action="" enctype="multipart/form-data" class="p-6 space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <div>
                <label class="block text-gray-300 text-sm font-medium mb-1">رابط الصورة الحالي (اتركه إذا لم تريد تغييره)</label>
                <input type="text" name="image_url" id="edit_image_url" placeholder="https://..."
                    class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-gray-300 text-sm font-medium mb-1">رفع صورة جديدة (اختياري)</label>
                <input type="file" name="image_file" accept="image/*"
                    class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none file:bg-blue-600 file:text-white file:border-0 file:rounded-lg file:px-4 file:py-1 file:me-3 cursor-pointer">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">العنوان</label>
                    <input type="text" name="title" id="edit_title"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">العنوان الفرعي</label>
                    <input type="text" name="subtitle" id="edit_subtitle"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none">
                </div>
            </div>
            <div>
                <label class="block text-gray-300 text-sm font-medium mb-1">الوصف</label>
                <textarea name="description" id="edit_description" rows="2"
                    class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none"></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">السعر الأصلي</label>
                    <input type="text" name="highlight_regular_price" id="edit_reg_price"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">سعر البيع</label>
                    <input type="text" name="highlight_sale_price" id="edit_sale_price"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">نسبة الخصم</label>
                    <input type="text" name="highlight_discount" id="edit_discount"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">رابط زر التسوق</label>
                    <input type="text" name="link_url" id="edit_link_url"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-1">الترتيب</label>
                    <input type="number" name="sort_order" id="edit_sort_order" min="0"
                        class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none">
                </div>
            </div>
            <div class="flex items-center gap-3">
                <input type="checkbox" name="is_active" id="edit_is_active" class="w-5 h-5 accent-blue-600 cursor-pointer">
                <label for="edit_is_active" class="text-gray-300 font-medium cursor-pointer">البانر مفعّل</label>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition">
                    <i class='bx bx-save me-2'></i> حفظ التعديلات
                </button>
                <button type="button" onclick="document.getElementById('editModal').classList.add('hidden')"
                    class="bg-gray-700 hover:bg-gray-600 text-white py-3 px-6 rounded-xl transition">إلغاء</button>
            </div>
        </form>
    </div>
</div>

<script>
function openEditModal(id, data) {
    document.getElementById('editForm').action = '/admin/banners/edit/' + id;
    document.getElementById('edit_image_url').value  = data.image_url || '';
    document.getElementById('edit_title').value       = data.title || '';
    document.getElementById('edit_subtitle').value    = data.subtitle || '';
    document.getElementById('edit_description').value = data.description || '';
    document.getElementById('edit_reg_price').value   = data.highlight_regular_price || '';
    document.getElementById('edit_sale_price').value  = data.highlight_sale_price || '';
    document.getElementById('edit_discount').value    = data.highlight_discount || '';
    document.getElementById('edit_link_url').value    = data.link_url || '/shop';
    document.getElementById('edit_sort_order').value  = data.sort_order ?? 0;
    document.getElementById('edit_is_active').checked = !!data.is_active;
    document.getElementById('editModal').classList.remove('hidden');
}
// Close modal on backdrop click
['addModal','editModal'].forEach(id => {
    document.getElementById(id).addEventListener('click', function(e){
        if(e.target === this) this.classList.add('hidden');
    });
});
</script>
{% endblock %}
