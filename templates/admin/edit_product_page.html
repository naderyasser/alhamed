{% extends 'admin/base.html' %}
{% block title %}تعديل المنتج — {{ product.name }}{% endblock %}
{% block content %}

<div class="min-h-screen" style="background:#000;">
    <!-- Page Header -->
    <div class="px-6 py-6">
        <!-- Breadcrumb -->
        <div class="flex items-center gap-2 text-sm text-slate-400 mb-6">
            <a href="/admin" class="hover:text-white transition-colors">لوحة التحكم</a>
            <i class='bx bx-chevron-left'></i>
            <a href="{{ url_for('admin.products') }}" class="hover:text-white transition-colors">المنتجات</a>
            <i class='bx bx-chevron-left'></i>
            <span class="text-white">تعديل: {{ product.name }}</span>
        </div>

        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg"
                     style="background: linear-gradient(135deg, #f97316, #ea580c);">
                    <i class='bx bx-edit'></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white">تعديل المنتج</h1>
                    <p class="text-slate-400 text-sm mt-0.5">{{ product.name }}</p>
                </div>
            </div>
            <a href="{{ url_for('admin.products') }}"
               class="flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200"
               style="background:#111; border:1px solid #333; color:#ccc;">
                <i class='bx bx-arrow-back'></i>
                رجوع للمنتجات
            </a>
        </div>

        <!-- Form Card -->
        <div class="rounded-2xl shadow-2xl overflow-hidden" style="background:#0a0a0a; border:1px solid #222;">
            <form method="POST" enctype="multipart/form-data"
                  action="{{ url_for('admin.edit_product', product_id=product.id) }}"
                  class="p-8">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">

                    <!-- ══ Left Column ══ -->
                    <div class="space-y-6">

                        <!-- Name -->
                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color:#ccc;">
                                اسم المنتج <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="name" value="{{ product.name }}" required
                                   class="w-full px-4 py-3 rounded-xl text-white placeholder-slate-500 transition-all duration-200 outline-none"
                                   style="background:#111; border:1px solid #333;"
                                   onfocus="this.style.borderColor='#d32f2f'" onblur="this.style.borderColor='#333'">
                        </div>

                        <!-- Category -->
                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color:#ccc;">
                                التصنيف <span class="text-red-500">*</span>
                            </label>
                            <select name="category" required
                                    class="w-full px-4 py-3 rounded-xl text-white transition-all duration-200 outline-none"
                                    style="background:#111; border:1px solid #333;">
                                <option value="">اختر التصنيف</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}"
                                    {% if category.id == product.category_id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Price & Discount -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2" style="color:#ccc;">
                                    السعر <span class="text-red-500">*</span>
                                </label>
                                <input type="number" step="0.01" name="price" value="{{ product.price }}" required
                                       class="w-full px-4 py-3 rounded-xl text-white outline-none transition-all duration-200"
                                       style="background:#111; border:1px solid #333;"
                                       onfocus="this.style.borderColor='#d32f2f'" onblur="this.style.borderColor='#333'">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2" style="color:#ccc;">الخصم (%)</label>
                                <input type="number" name="discount" value="{{ product.discount }}" min="0" max="100"
                                       class="w-full px-4 py-3 rounded-xl text-white outline-none transition-all duration-200"
                                       style="background:#111; border:1px solid #333;"
                                       onfocus="this.style.borderColor='#d32f2f'" onblur="this.style.borderColor='#333'">
                            </div>
                        </div>

                        <!-- Stock -->
                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color:#ccc;">
                                الكمية في المخزون <span class="text-red-500">*</span>
                            </label>
                            <input type="number" name="quantity" value="{{ product.stock }}" required min="0"
                                   class="w-full px-4 py-3 rounded-xl text-white outline-none transition-all duration-200"
                                   style="background:#111; border:1px solid #333;"
                                   onfocus="this.style.borderColor='#d32f2f'" onblur="this.style.borderColor='#333'">
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color:#ccc;">وصف المنتج</label>
                            <textarea name="description" rows="5"
                                      class="w-full px-4 py-3 rounded-xl text-white resize-none outline-none transition-all duration-200"
                                      style="background:#111; border:1px solid #333;"
                                      onfocus="this.style.borderColor='#d32f2f'" onblur="this.style.borderColor='#333'">{{ product.description }}</textarea>
                        </div>
                    </div>

                    <!-- ══ Right Column ══ -->
                    <div class="space-y-6">

                        <!-- Current Image -->
                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color:#ccc;">الصورة الحالية</label>
                            <div class="rounded-xl p-4 flex justify-center" style="background:#111; border:1px solid #333;">
                                <img src="/{{ product.image }}" alt="{{ product.name }}"
                                     class="w-36 h-36 object-cover rounded-xl"
                                     onerror="this.onerror=null; this.src='/static/images/placeholder-product.svg'">
                            </div>
                        </div>

                        <!-- New Image Upload (Drag-and-Drop) -->
                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color:#ccc;">تغيير الصورة (اختياري)</label>
                            <div id="editDropZone"
                                 class="rounded-xl p-8 text-center cursor-pointer transition-all duration-200"
                                 style="border:2px dashed #444; background:#0d0d0d;">
                                <div id="editImagePreview" class="hidden">
                                    <img id="editPreviewImg" src="" alt="معاينة"
                                         class="w-32 h-32 object-cover rounded-xl mx-auto mb-3">
                                    <button type="button" onclick="clearEditPreview()"
                                            class="text-xs text-red-400 hover:text-red-300 underline">إزالة الصورة الجديدة</button>
                                </div>
                                <div id="editUploadPlaceholder">
                                    <i class='bx bx-cloud-upload text-5xl mb-3' style="color:#555;"></i>
                                    <p class="font-medium mb-1" style="color:#aaa;">اسحب وأفلت صورة جديدة هنا</p>
                                    <p class="text-sm mb-3" style="color:#555;">أو</p>
                                    <label for="editProductImage"
                                           class="px-4 py-2 rounded-lg cursor-pointer font-medium text-sm transition-colors"
                                           style="background:#222; color:#ccc; border:1px solid #444;">
                                        اختر ملفًا
                                    </label>
                                </div>
                                <input type="file" id="editProductImage" name="image" accept="image/*" class="hidden">
                                <p class="text-xs mt-3" style="color:#444;">JPG، PNG أو GIF — بحد أقصى 5MB</p>
                            </div>
                        </div>

                        <!-- Additional Images -->
                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color:#ccc;">الصور الإضافية الحالية</label>
                            {% if product.additional_images %}
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                {% for img in product.additional_images %}
                                <div class="relative rounded-lg overflow-hidden" style="border:1px solid #333;">
                                    <img src="/{{ img.image }}" alt="صورة إضافية" class="w-full h-24 object-cover">
                                    <button type="button" data-remove-img="{{ img.id }}"
                                            class="absolute top-1 right-1 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold transition-colors"
                                            style="background:#d32f2f; color:#fff;">×</button>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-sm mb-3" style="color:#555;">لا توجد صور إضافية</p>
                            {% endif %}

                            <label class="block text-sm font-semibold mb-2" style="color:#ccc;">إضافة صور جديدة (اختياري)</label>
                            <input type="file" name="additional_images" multiple accept="image/*"
                                   class="w-full px-4 py-3 rounded-xl text-sm outline-none"
                                   style="background:#111; border:1px solid #333; color:#aaa;">
                            <p class="text-xs mt-1" style="color:#555;">يمكن اختيار عدة صور</p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-between items-center mt-10 pt-6" style="border-top:1px solid #222;">
                    <a href="{{ url_for('admin.products') }}"
                       class="px-6 py-3 rounded-xl font-medium text-sm transition-all duration-200"
                       style="background:#111; border:1px solid #333; color:#aaa;">
                        إلغاء
                    </a>
                    <button type="submit"
                            class="flex items-center gap-2 px-8 py-3 rounded-xl font-semibold text-white transition-all duration-300 shadow-lg"
                            style="background: linear-gradient(135deg, #f97316, #ea580c);">
                        <i class='bx bx-save text-lg'></i>
                        حفظ التعديلات
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // ── Drag-and-Drop for Edit Page ──
    const editDropZone   = document.getElementById('editDropZone');
    const editInput      = document.getElementById('editProductImage');

    function showEditPreview(file) {
        if (!file || !file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('editPreviewImg').src = e.target.result;
            document.getElementById('editImagePreview').classList.remove('hidden');
            document.getElementById('editUploadPlaceholder').classList.add('hidden');
        };
        reader.readAsDataURL(file);
    }

    function clearEditPreview() {
        editInput.value = '';
        document.getElementById('editPreviewImg').src = '';
        document.getElementById('editImagePreview').classList.add('hidden');
        document.getElementById('editUploadPlaceholder').classList.remove('hidden');
    }

    editDropZone.addEventListener('click', e => {
        if (!e.target.closest('label') && !e.target.closest('button')) editInput.click();
    });

    editInput.addEventListener('change', e => {
        if (e.target.files[0]) showEditPreview(e.target.files[0]);
    });

    editDropZone.addEventListener('dragover', e => {
        e.preventDefault();
        editDropZone.style.borderColor = '#d32f2f';
        editDropZone.style.background  = '#110000';
    });
    editDropZone.addEventListener('dragleave', e => {
        if (!editDropZone.contains(e.relatedTarget)) {
            editDropZone.style.borderColor = '#444';
            editDropZone.style.background  = '#0d0d0d';
        }
    });
    editDropZone.addEventListener('drop', e => {
        e.preventDefault();
        editDropZone.style.borderColor = '#444';
        editDropZone.style.background  = '#0d0d0d';
        const file = e.dataTransfer.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) { alert('يرجى رفع ملف صورة فقط'); return; }
        if (file.size > 5 * 1024 * 1024)    { alert('حجم الصورة يتجاوز الحد الأقصى (5MB)'); return; }
        const dt = new DataTransfer();
        dt.items.add(file);
        editInput.files = dt.files;
        showEditPreview(file);
    });

    // ── Remove additional image (delegated) ──
    document.querySelectorAll('[data-remove-img]').forEach(btn => {
        btn.addEventListener('click', () => removeAdditionalImage(btn.dataset.removeImg));
    });

    function removeAdditionalImage(imageId) {
        if (!confirm('هل تريد حذف هذه الصورة؟')) return;
        fetch('/admin/delete_additional_image/' + imageId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert('حدث خطأ أثناء حذف الصورة');
        })
        .catch(() => alert('حدث خطأ أثناء حذف الصورة'));
    }
</script>

{% endblock %}
